<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBD Errors Decoder</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--tg-theme-text-color, #000000);
        }

        .header p {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--tg-theme-hint-color, #e0e0e0);
            z-index: 1;
        }

        .step {
            position: relative;
            z-index: 2;
            background: var(--tg-theme-bg-color, #ffffff);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid var(--tg-theme-hint-color, #e0e0e0);
            color: var(--tg-theme-hint-color, #999999);
        }

        .step.active {
            background: var(--tg-theme-button-color, #2481cc);
            border-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .step.completed {
            background: var(--tg-theme-button-color, #2481cc);
            border-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .form-step {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .form-step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
        }

        .dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--tg-theme-hint-color, #e0e0e0);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            cursor: pointer;
        }

        .dropdown-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #2481cc);
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--tg-theme-bg-color, #ffffff);
            border: 2px solid var(--tg-theme-hint-color, #e0e0e0);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .dropdown-list.show {
            display: block;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            font-size: 14px;
            background: transparent;
            color: var(--tg-theme-text-color, #000000);
        }

        .search-input:focus {
            outline: none;
            border-bottom-color: var(--tg-theme-button-color, #2481cc);
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background: var(--tg-theme-hint-color, #f5f5f5);
        }

        .dropdown-item.selected {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .popular-brands {
            padding: 16px;
        }

        .popular-brands h4 {
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .brand-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .brand-tag {
            padding: 6px 12px;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .brand-tag:hover {
            opacity: 0.8;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-back {
            background: transparent;
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .btn-back:hover {
            background: var(--tg-theme-hint-color, #f5f5f5);
        }

        .btn-secondary {
            background: transparent;
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .btn-secondary:hover {
            background: var(--tg-theme-hint-color, #f5f5f5);
        }

        .model-buttons, .generation-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .model-button, .generation-button {
            padding: 12px 16px;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .model-button:hover, .generation-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .selected-model, .selected-generation {
            background: var(--tg-theme-hint-color, #f8f9fa);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .car-info {
            background: var(--tg-theme-hint-color, #f8f9fa);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .car-info h4 {
            margin-bottom: 12px;
            color: var(--tg-theme-text-color, #000000);
        }

        .car-info p {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .car-info strong {
            color: var(--tg-theme-text-color, #000000);
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 14px;
        }

        .status.connected {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status.disconnected {
            background: #ffebee;
            color: #c62828;
        }

        .example-item {
            padding: 8px 12px;
            background: var(--tg-theme-hint-color, #f5f5f5);
            border-radius: 6px;
            margin: 4px 0;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .example-item:hover {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        /* Стили для кнопок марок */
        .brand-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .brand-button {
            padding: 12px 16px;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brand-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .brand-button.selected {
            background: var(--tg-theme-button-color, #2481cc);
            box-shadow: 0 2px 8px rgba(36, 129, 204, 0.3);
        }

        .selected-brand {
            background: var(--tg-theme-hint-color, #f8f9fa);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .selected-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-change {
            padding: 6px 12px;
            background: transparent;
            color: var(--tg-theme-button-color, #2481cc);
            border: 1px solid var(--tg-theme-button-color, #2481cc);
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .search-section {
            margin-top: 20px;
        }

        .search-results {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 8px 12px;
            background: var(--tg-theme-hint-color, #f5f5f5);
            border-radius: 6px;
            margin: 2px 0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 Расшифровка OBD ошибок</h1>
            <p>Введите код ошибки и выберите автомобиль для точной диагностики</p>
        </div>

        <div class="status" id="status">
            Проверка подключения...
        </div>

        <!-- Индикатор шагов -->
        <div class="step-indicator">
            <div class="step active" id="step1">1</div>
            <div class="step" id="step2">2</div>
            <div class="step" id="step3">3</div>
            <div class="step" id="step4">4</div>
        </div>

        <!-- Шаг 1: Код ошибки -->
        <div class="form-step active" id="step1-content">
            <div class="input-group">
                <label for="errorCode">Код ошибки OBD:</label>
                <input 
                    type="text" 
                    id="errorCode" 
                    placeholder="Например: P0300, C1234, U0100..."
                    style="width: 100%; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;"
                >
            </div>

            <div class="example-item" onclick="setErrorCode('P0300')">P0300 - Пропуски зажигания</div>
            <div class="example-item" onclick="setErrorCode('P0171')">P0171 - Бедная смесь</div>
            <div class="example-item" onclick="setErrorCode('P0420')">P0420 - Катализатор</div>
            <div class="example-item" onclick="setErrorCode('C1234')">C1234 - АБС</div>

            <button class="btn btn-primary" onclick="nextStep()">
                Далее →
            </button>
        </div>

        <!-- Шаг 2: Марка автомобиля -->
        <div class="form-step" id="step2-content">
            <div class="input-group">
                <label for="carBrand">Марка автомобиля:</label>
                <div class="selected-brand" id="selectedBrand" style="display: none;">
                    <div class="selected-item">
                        <span id="selectedBrandName"></span>
                        <button class="btn-change" onclick="changeBrand()">Изменить</button>
                    </div>
                </div>
                <div class="brand-selection" id="brandSelection">
                    <h4>Популярные марки:</h4>
                    <div class="brand-buttons" id="popularBrandButtons">
                        <!-- Заполнится динамически -->
                    </div>
                    <div class="search-section">
                        <input type="text" class="search-input" placeholder="Поиск марки..." id="brandSearch">
                        <div class="search-results" id="brandSearchResults"></div>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="nextStep()" id="nextStepBtn" disabled>
                Далее →
            </button>
            <button class="btn btn-secondary" onclick="skipMark()" style="margin-left: 10px;">
                Продолжить без марки
            </button>
            <button class="btn btn-back" onclick="prevStep()">
                ← Назад
            </button>
        </div>

        <!-- Шаг 3: Модель автомобиля -->
        <div class="form-step" id="step3-content">
            <div class="input-group">
                <label for="carModel">Модель автомобиля:</label>
                <div class="selected-model" id="selectedModel" style="display: none;">
                    <div class="selected-item">
                        <span id="selectedModelName"></span>
                        <button class="btn-change" onclick="changeModel()">Изменить</button>
                    </div>
                </div>
                <div class="model-selection" id="modelSelection">
                    <h4>Модели:</h4>
                    <div class="model-buttons" id="modelButtons">
                        <!-- Заполнится динамически -->
                    </div>
                    <div class="search-section">
                        <input type="text" class="search-input" placeholder="Поиск модели..." id="modelSearch">
                        <div class="search-results" id="modelSearchResults"></div>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="nextStep()" id="nextStepBtn3" disabled>
                Далее →
            </button>
            <button class="btn btn-secondary" onclick="skipModel()" style="margin-left: 10px;">
                Продолжить без модели
            </button>
            <button class="btn btn-back" onclick="prevStep()">
                ← Назад
            </button>
        </div>

        <!-- Шаг 4: Поколение автомобиля -->
        <div class="form-step" id="step4-content">
            <div class="input-group">
                <label for="carGeneration">Поколение автомобиля:</label>
                <div class="selected-generation" id="selectedGeneration" style="display: none;">
                    <div class="selected-item">
                        <span id="selectedGenerationName"></span>
                        <button class="btn-change" onclick="changeGeneration()">Изменить</button>
                    </div>
                </div>
                <div class="generation-selection" id="generationSelection">
                    <h4>Поколения:</h4>
                    <div class="generation-buttons" id="generationButtons">
                        <!-- Заполнится динамически -->
                    </div>
                    <div class="search-section">
                        <input type="text" class="search-input" placeholder="Поиск поколения..." id="generationSearch">
                        <div class="search-results" id="generationSearchResults"></div>
                    </div>
                </div>
            </div>

            <div class="car-info" id="carInfo" style="display: none;">
                <h4>📋 Собранная информация:</h4>
                <p><strong>Код ошибки:</strong> <span id="infoCode"></span></p>
                <p><strong>Автомобиль:</strong> <span id="infoCar"></span></p>
            </div>

            <button class="btn btn-primary" onclick="sendErrorCode()" id="sendBtn" disabled>
                🔍 Расшифровать ошибку
            </button>
            <button class="btn btn-secondary" onclick="skipGeneration()" style="margin-left: 10px;">
                Продолжить без поколения
            </button>
            <button class="btn btn-back" onclick="prevStep()">
                ← Назад
            </button>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let currentStep = 1;
        let formData = {
            errorCode: '',
            markId: null,
            modelId: null,
            generationId: null,
            carInfo: null
        };

        // Данные из JSON файлов
        let marksData = [];
        let modelsData = [];
        let generationsData = [];

        // Элементы формы
        const errorInput = document.getElementById('errorCode');
        const brandInput = document.getElementById('carBrand');
        const modelInput = document.getElementById('carModel');
        const generationInput = document.getElementById('carGeneration');
        const carInfo = document.getElementById('carInfo');

        // Инициализация
        tg.ready();
        tg.expand();
        checkConnection();
        loadJsonData(); // Загружаем JSON данные

        function checkConnection() {
            const status = document.getElementById('status');
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                status.textContent = '✅ Подключено к Telegram';
                status.className = 'status connected';
            } else {
                status.textContent = '❌ Не подключено к Telegram (тестовый режим)';
                status.className = 'status disconnected';
            }
        }

        function updateStepIndicator() {
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                if (i < currentStep) {
                    step.className = 'step completed';
                } else if (i === currentStep) {
                    step.className = 'step active';
                } else {
                    step.className = 'step';
                }
            }
        }

        function nextStep() {
            if (currentStep === 1) {
                if (!formData.errorCode.trim()) {
                    showError('Пожалуйста, введите код ошибки');
                    return;
                }
                formData.errorCode = formData.errorCode.trim().toUpperCase();
            } else if (currentStep === 2) {
                if (!formData.markId) {
                    showError('Пожалуйста, выберите марку автомобиля');
                    return;
                }
            } else if (currentStep === 3) {
                if (!formData.modelId) {
                    showError('Пожалуйста, выберите модель автомобиля');
                    return;
                }
            }

            if (currentStep < 4) {
                currentStep++;
                updateStepIndicator();
                
                // Скрываем все шаги
                document.querySelectorAll('.form-step').forEach(step => {
                    step.classList.remove('active');
                });
                
                // Показываем текущий шаг
                document.getElementById(`step${currentStep}-content`).classList.add('active');
                
                // Загружаем данные для нового шага
                if (currentStep === 2) {
                    loadMarks();
                } else if (currentStep === 3) {
                    loadModels();
                } else if (currentStep === 4) {
                    loadGenerations();
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepIndicator();
                
                // Скрываем все шаги
                document.querySelectorAll('.form-step').forEach(step => {
                    step.classList.remove('active');
                });
                
                // Показываем текущий шаг
                document.getElementById(`step${currentStep}-content`).classList.add('active');
            }
        }

        // Загрузка JSON данных
        async function loadJsonData() {
            try {
                const [marksResponse, modelsResponse, generationsResponse] = await Promise.all([
                    fetch('marks.json'),
                    fetch('models.json'),
                    fetch('generations.json')
                ]);
                
                marksData = await marksResponse.json();
                modelsData = await modelsResponse.json();
                generationsData = await generationsResponse.json();
                
                console.log(`Загружено: ${marksData.length} марок, ${modelsData.length} моделей, ${generationsData.length} поколений`);
            } catch (error) {
                console.error('Ошибка загрузки JSON данных:', error);
            }
        }

        // Получение популярных марок (первые 30)
        function getPopularMarks() {
            return marksData.slice(0, 30);
        }

        // Поиск марок
        function searchMarks(query) {
            const lowerQuery = query.toLowerCase();
            return marksData.filter(mark => 
                mark.name.toLowerCase().includes(lowerQuery) || 
                (mark.cyrillic_name && mark.cyrillic_name.toLowerCase().includes(lowerQuery))
            ).slice(0, 20); // Ограничиваем результатами
        }

        // Получение моделей по марке
        function getModelsByMark(markId) {
            return modelsData.filter(model => model.mark_id === markId);
        }

        // Поиск моделей
        function searchModels(markId, query) {
            const lowerQuery = query.toLowerCase();
            const models = getModelsByMark(markId);
            return models.filter(model => 
                model.name.toLowerCase().includes(lowerQuery) || 
                (model.cyrillic_name && model.cyrillic_name.toLowerCase().includes(lowerQuery))
            ).slice(0, 20);
        }

        // Получение поколений по модели
        function getGenerationsByModel(modelId) {
            return generationsData.filter(generation => generation.model_id === modelId);
        }

        // Поиск поколений
        function searchGenerations(modelId, query) {
            const lowerQuery = query.toLowerCase();
            const generations = getGenerationsByModel(modelId);
            return generations.filter(generation => 
                generation.year_start.toString().includes(lowerQuery) || 
                generation.year_stop.toString().includes(lowerQuery)
            ).slice(0, 20);
        }

        // Загрузка данных
        async function loadMarks() {
            const popularMarks = getPopularMarks();
            
            // Заполняем кнопки популярных марок
            const popularBrandButtons = document.getElementById('popularBrandButtons');
            popularBrandButtons.innerHTML = '';
            popularMarks.forEach(mark => {
                const button = document.createElement('button');
                button.className = 'brand-button';
                button.textContent = mark.name; // Показываем английские названия
                button.onclick = () => selectMark(mark);
                popularBrandButtons.appendChild(button);
            });
            
            // Настраиваем поиск
            setupBrandSearch();
        }

        async function loadModels() {
            if (!formData.markId) return;
            
            const models = getModelsByMark(formData.markId);
            
            // Заполняем кнопки моделей
            const modelButtons = document.getElementById('modelButtons');
            modelButtons.innerHTML = '';
            models.slice(0, 30).forEach(model => { // Показываем первые 30
                const button = document.createElement('button');
                button.className = 'model-button';
                button.textContent = model.name; // Показываем английские названия
                button.onclick = () => selectModel(model);
                modelButtons.appendChild(button);
            });
            
            // Настраиваем поиск
            setupModelSearch();
        }

        async function loadGenerations() {
            if (!formData.modelId) return;
            
            const generations = getGenerationsByModel(formData.modelId);
            
            // Заполняем кнопки поколений
            const generationButtons = document.getElementById('generationButtons');
            generationButtons.innerHTML = '';
            generations.slice(0, 30).forEach(generation => { // Показываем первые 30
                const button = document.createElement('button');
                button.className = 'generation-button';
                const yearText = generation.year_start === generation.year_stop ? 
                    generation.year_start : 
                    `${generation.year_start}-${generation.year_stop}`;
                button.textContent = yearText;
                button.onclick = () => selectGeneration(generation);
                generationButtons.appendChild(button);
            });
            
            // Настраиваем поиск
            setupGenerationSearch();
        }

        // Настройка поиска марок
        function setupBrandSearch() {
            const brandSearch = document.getElementById('brandSearch');
            
            brandSearch.oninput = () => {
                const query = brandSearch.value.trim();
                if (query.length < 2) {
                    showBrandResults([]);
                    return;
                }
                
                const marks = searchMarks(query);
                showBrandResults(marks);
            };
        }

        function showBrandResults(marks) {
            const searchResults = document.getElementById('brandSearchResults');
            searchResults.innerHTML = '';
            
            marks.forEach(mark => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.textContent = mark.name; // Показываем английские названия
                item.onclick = () => selectMark(mark);
                searchResults.appendChild(item);
            });
        }

        function showModelResults(models) {
            const searchResults = document.getElementById('modelSearchResults');
            searchResults.innerHTML = '';
            
            models.forEach(model => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.textContent = model.name; // Показываем английские названия
                item.onclick = () => selectModel(model);
                searchResults.appendChild(item);
            });
        }

        function showGenerationResults(generations) {
            const searchResults = document.getElementById('generationSearchResults');
            searchResults.innerHTML = '';
            
            generations.forEach(generation => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                const yearText = generation.year_start === generation.year_stop ? 
                    generation.year_start : 
                    `${generation.year_start}-${generation.year_stop}`;
                item.textContent = yearText;
                item.onclick = () => selectGeneration(generation);
                searchResults.appendChild(item);
            });
        }

        function selectMark(mark) {
            formData.markId = mark.id;
            
            // Показываем выбранную марку
            const selectedBrand = document.getElementById('selectedBrand');
            const selectedBrandName = document.getElementById('selectedBrandName');
            const brandSelection = document.getElementById('brandSelection');
            const nextStepBtn = document.getElementById('nextStepBtn');
            
            selectedBrandName.textContent = mark.name; // Показываем английские названия
            selectedBrand.style.display = 'block';
            brandSelection.style.display = 'none';
            nextStepBtn.disabled = false;
            
            // Очищаем следующие поля
            formData.modelId = null;
            formData.generationId = null;
            formData.carInfo = null;
        }

        function selectModel(model) {
            formData.modelId = model.id;
            
            // Показываем выбранную модель
            const selectedModel = document.getElementById('selectedModel');
            const selectedModelName = document.getElementById('selectedModelName');
            const modelSelection = document.getElementById('modelSelection');
            const nextStepBtn = document.getElementById('nextStepBtn3');
            
            selectedModelName.textContent = model.name; // Показываем английские названия
            selectedModel.style.display = 'block';
            modelSelection.style.display = 'none';
            nextStepBtn.disabled = false;
            
            // Очищаем следующие поля
            formData.generationId = null;
            formData.carInfo = null;
        }

        function selectGeneration(generation) {
            formData.generationId = generation.id;
            
            // Показываем выбранное поколение
            const selectedGeneration = document.getElementById('selectedGeneration');
            const selectedGenerationName = document.getElementById('selectedGenerationName');
            const generationSelection = document.getElementById('generationSelection');
            const sendBtn = document.getElementById('sendBtn');
            
            const yearText = generation.year_start === generation.year_stop ? 
                generation.year_start : 
                `${generation.year_start}-${generation.year_stop}`;
            selectedGenerationName.textContent = yearText;
            selectedGeneration.style.display = 'block';
            generationSelection.style.display = 'none';
            sendBtn.disabled = false;
            
            // Обновляем информацию об автомобиле
            updateCarInfo();
        }

        // Функции пропуска шагов
        function skipMark() {
            formData.markId = null;
            nextStep();
        }

        function skipModel() {
            formData.modelId = null;
            nextStep();
        }

        function skipGeneration() {
            formData.generationId = null;
            sendErrorCode();
        }

        // Функции изменения выбора
        function changeBrand() {
            const selectedBrand = document.getElementById('selectedBrand');
            const brandSelection = document.getElementById('brandSelection');
            const nextStepBtn = document.getElementById('nextStepBtn');
            
            selectedBrand.style.display = 'none';
            brandSelection.style.display = 'block';
            nextStepBtn.disabled = true;
            formData.markId = null;
        }

        // Настройка поиска моделей
        function setupModelSearch() {
            const modelSearch = document.getElementById('modelSearch');
            
            modelSearch.oninput = () => {
                const query = modelSearch.value.trim();
                if (query.length < 2) {
                    showModelResults([]);
                    return;
                }
                
                const models = searchModels(formData.markId, query);
                showModelResults(models);
            };
        }

        // Настройка поиска поколений
        function setupGenerationSearch() {
            const generationSearch = document.getElementById('generationSearch');
            
            generationSearch.oninput = () => {
                const query = generationSearch.value.trim();
                if (query.length < 1) {
                    showGenerationResults([]);
                    return;
                }
                
                const generations = searchGenerations(formData.modelId, query);
                showGenerationResults(generations);
            };
        }

        function changeModel() {
            const selectedModel = document.getElementById('selectedModel');
            const modelSelection = document.getElementById('modelSelection');
            const nextStepBtn = document.getElementById('nextStepBtn3');
            
            selectedModel.style.display = 'none';
            modelSelection.style.display = 'block';
            nextStepBtn.disabled = true;
            formData.modelId = null;
        }

        function changeGeneration() {
            const selectedGeneration = document.getElementById('selectedGeneration');
            const generationSelection = document.getElementById('generationSelection');
            const sendBtn = document.getElementById('sendBtn');
            
            selectedGeneration.style.display = 'none';
            generationSelection.style.display = 'block';
            sendBtn.disabled = true;
            formData.generationId = null;
        }

        function changeBrand() {
            const selectedBrand = document.getElementById('selectedBrand');
            const brandSelection = document.getElementById('brandSelection');
            const nextStepBtn = document.getElementById('nextStepBtn');
            
            selectedBrand.style.display = 'none';
            brandSelection.style.display = 'block';
            nextStepBtn.disabled = true;
            
            formData.markId = null;
        }

        // Настройка поиска моделей
        function setupModelSearch(models) {
            const modelSearch = document.getElementById('modelSearch');
            const modelDropdown = document.getElementById('modelDropdown');
            
            modelSearch.oninput = () => {
                const query = modelSearch.value.toLowerCase();
                const filtered = models.filter(model => 
                    model.name.toLowerCase().includes(query) || 
                    (model.cyrillic_name && model.cyrillic_name.toLowerCase().includes(query))
                );
                showModelResults(filtered);
            };
            
            modelInput.onclick = () => {
                modelDropdown.classList.add('show');
                modelSearch.focus();
            };
        }

        function showModelResults(models) {
            const modelDropdown = document.getElementById('modelDropdown');
            const items = modelDropdown.querySelectorAll('.dropdown-item');
            items.forEach(item => item.remove());
            
            models.forEach(model => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = model.cyrillic_name || model.name;
                item.onclick = () => selectModel(model);
                modelDropdown.appendChild(item);
            });
        }

        function selectModel(model) {
            formData.modelId = model.id;
            modelInput.value = model.cyrillic_name || model.name;
            document.getElementById('modelDropdown').classList.remove('show');
            // Очищаем следующее поле
            generationInput.value = '';
            formData.generationId = null;
            formData.carInfo = null;
        }

        // Настройка поиска поколений
        function setupGenerationSearch(generations) {
            const generationSearch = document.getElementById('generationSearch');
            const generationDropdown = document.getElementById('generationDropdown');
            
            generationSearch.oninput = () => {
                const query = generationSearch.value.toLowerCase();
                const filtered = generations.filter(gen => 
                    gen.name.toLowerCase().includes(query)
                );
                showGenerationResults(filtered);
            };
            
            generationInput.onclick = () => {
                generationDropdown.classList.add('show');
                generationSearch.focus();
            };
        }

        function showGenerationResults(generations) {
            const generationDropdown = document.getElementById('generationDropdown');
            const items = generationDropdown.querySelectorAll('.dropdown-item');
            items.forEach(item => item.remove());
            
            generations.forEach(generation => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                const yearText = generation.year_stop ? `${generation.year_start}-${generation.year_stop}` : `${generation.year_start}-`;
                item.textContent = `${generation.name} (${yearText})`;
                item.onclick = () => selectGeneration(generation);
                generationDropdown.appendChild(item);
            });
        }

        function selectGeneration(generation) {
            formData.generationId = generation.id;
            formData.carInfo = {
                mark: brandInput.value,
                model: modelInput.value,
                generation: generation.name,
                yearFrom: generation.year_start,
                yearTo: generation.year_stop
            };
            const yearText = generation.year_stop ? `${generation.year_start}-${generation.year_stop}` : `${generation.year_start}-`;
            generationInput.value = `${generation.name} (${yearText})`;
            document.getElementById('generationDropdown').classList.remove('show');
            showCarInfo();
        }

        function showCarInfo() {
            if (formData.carInfo) {
                document.getElementById('infoCode').textContent = formData.errorCode;
                const yearText = formData.carInfo.yearTo ? `${formData.carInfo.yearFrom}-${formData.carInfo.yearTo}` : `${formData.carInfo.yearFrom}-`;
                document.getElementById('infoCar').textContent = 
                    `${formData.carInfo.mark} ${formData.carInfo.model} ${formData.carInfo.generation} (${yearText})`;
                carInfo.style.display = 'block';
            }
        }

        function setErrorCode(code) {
            errorInput.value = code;
            formData.errorCode = code;
        }

        function updateCarInfo() {
            if (formData.markId && formData.modelId && formData.generationId) {
                const mark = marksData.find(m => m.id === formData.markId);
                const model = modelsData.find(m => m.id === formData.modelId);
                const generation = generationsData.find(g => g.id === formData.generationId);
                
                if (mark && model && generation) {
                    formData.carInfo = {
                        mark: mark.name,
                        model: model.name,
                        generation: `${generation.year_start}-${generation.year_stop}`,
                        yearFrom: generation.year_start,
                        yearTo: generation.year_stop
                    };
                    
                    // Показываем информацию об автомобиле
                    document.getElementById('infoCode').textContent = formData.errorCode;
                    document.getElementById('infoCar').textContent = `${mark.name} ${model.name} ${generation.year_start}-${generation.year_stop}`;
                    document.getElementById('carInfo').style.display = 'block';
                }
            }
        }

        async function sendErrorCode() {
            const errorCode = formData.errorCode;
            const carInfo = formData.carInfo;
            
            if (!errorCode) {
                showError('Пожалуйста, введите код ошибки');
                return;
            }
            
            // Формируем сообщение для бота
            let message = `🔍 **Код ошибки:** ${errorCode}\n\n`;
            
            if (carInfo) {
                message += `🚗 **Автомобиль:**\n`;
                message += `• Марка: ${carInfo.mark}\n`;
                message += `• Модель: ${carInfo.model}\n`;
                message += `• Поколение: ${carInfo.generation}\n`;
                message += `• Годы: ${carInfo.yearFrom}-${carInfo.yearTo}\n\n`;
            }
            
            message += `📝 **Отправка в Telegram...**`;
            
            // В тестовом режиме показываем результат
            if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
                showSuccess(message);
                console.log('Тестовый режим - данные:', { errorCode, carInfo });
                return;
            }
            
            // Отправляем данные в Telegram
            tg.sendData(JSON.stringify({
                errorCode: errorCode,
                carInfo: carInfo
            }));
            
            showSuccess('✅ Данные отправлены в Telegram!');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function showResult(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.innerHTML = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/`(.*?)`/g, '<code>$1</code>');
            successDiv.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function resetForm() {
            errorInput.value = '';
            brandInput.value = '';
            modelInput.value = '';
            generationInput.value = '';
            formData = {
                errorCode: '',
                markId: null,
                modelId: null,
                generationId: null,
                carInfo: null
            };
            currentStep = 1;
            updateStepIndicator();
            document.querySelectorAll('.form-step').forEach(step => step.classList.remove('active'));
            document.getElementById('step1-content').classList.add('active');
            carInfo.style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        // Обработчики событий
        errorInput.addEventListener('input', function() {
            formData.errorCode = this.value;
        });

        // Закрытие dropdown при клике вне их
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-list').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });
    </script>
</body>
</html> 