<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBD Errors Decoder</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--tg-theme-text-color, #000000);
        }

        .header p {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--tg-theme-hint-color, #e0e0e0);
            z-index: 1;
        }

        .step {
            position: relative;
            z-index: 2;
            background: var(--tg-theme-bg-color, #ffffff);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid var(--tg-theme-hint-color, #e0e0e0);
            color: var(--tg-theme-hint-color, #999999);
        }

        .step.active {
            background: var(--tg-theme-button-color, #2481cc);
            border-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .step.completed {
            background: var(--tg-theme-button-color, #2481cc);
            border-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .form-step {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .form-step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
        }

        .dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--tg-theme-hint-color, #e0e0e0);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            cursor: pointer;
        }

        .dropdown-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #2481cc);
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--tg-theme-bg-color, #ffffff);
            border: 2px solid var(--tg-theme-hint-color, #e0e0e0);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .dropdown-list.show {
            display: block;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            font-size: 14px;
            background: transparent;
            color: var(--tg-theme-text-color, #000000);
        }

        .search-input:focus {
            outline: none;
            border-bottom-color: var(--tg-theme-button-color, #2481cc);
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background: var(--tg-theme-hint-color, #f5f5f5);
        }

        .dropdown-item.selected {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .popular-brands {
            padding: 16px;
        }

        .popular-brands h4 {
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .brand-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .brand-tag {
            padding: 6px 12px;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .brand-tag:hover {
            opacity: 0.8;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-back {
            background: transparent;
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .btn-back:hover {
            background: var(--tg-theme-hint-color, #f5f5f5);
        }

        .btn-secondary {
            background: transparent;
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .btn-secondary:hover {
            background: var(--tg-theme-hint-color, #f5f5f5);
        }

        .model-buttons, .generation-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .model-button, .generation-button {
            padding: 12px 16px;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .model-button:hover, .generation-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .selected-model, .selected-generation {
            background: var(--tg-theme-hint-color, #f8f9fa);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .car-info {
            background: var(--tg-theme-hint-color, #f8f9fa);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .car-info h4 {
            margin-bottom: 12px;
            color: var(--tg-theme-text-color, #000000);
        }

        .car-info p {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .car-info strong {
            color: var(--tg-theme-text-color, #000000);
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 14px;
        }

        .status.connected {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status.disconnected {
            background: #ffebee;
            color: #c62828;
        }

        .example-item {
            padding: 8px 12px;
            background: var(--tg-theme-hint-color, #f5f5f5);
            border-radius: 6px;
            margin: 4px 0;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .example-item:hover {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –º–∞—Ä–æ–∫ */
        .brand-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .brand-button {
            padding: 12px 16px;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brand-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .brand-button.selected {
            background: var(--tg-theme-button-color, #2481cc);
            box-shadow: 0 2px 8px rgba(36, 129, 204, 0.3);
        }

        .selected-brand {
            background: var(--tg-theme-hint-color, #f8f9fa);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .selected-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-change {
            padding: 6px 12px;
            background: transparent;
            color: var(--tg-theme-button-color, #2481cc);
            border: 1px solid var(--tg-theme-button-color, #2481cc);
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .search-section {
            margin-top: 20px;
        }

        .search-results {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 8px 12px;
            background: var(--tg-theme-hint-color, #f5f5f5);
            border-radius: 6px;
            margin: 2px 0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ OBD –æ—à–∏–±–æ–∫</h1>
            <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –æ—à–∏–±–∫–∏ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å –¥–ª—è —Ç–æ—á–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</p>
        </div>

        <div class="status" id="status">
            –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...
        </div>

        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —à–∞–≥–æ–≤ -->
        <div class="step-indicator">
            <div class="step active" id="step1">1</div>
            <div class="step" id="step2">2</div>
            <div class="step" id="step3">3</div>
            <div class="step" id="step4">4</div>
        </div>

        <!-- –®–∞–≥ 1: –ö–æ–¥ –æ—à–∏–±–∫–∏ -->
        <div class="form-step active" id="step1-content">
            <div class="input-group">
                <label for="errorCode">–ö–æ–¥ –æ—à–∏–±–∫–∏ OBD:</label>
                <input 
                    type="text" 
                    id="errorCode" 
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: P0300, C1234, U0100..."
                    style="width: 100%; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;"
                >
            </div>

            <div class="example-item" onclick="setErrorCode('P0300')">P0300 - –ü—Ä–æ–ø—É—Å–∫–∏ –∑–∞–∂–∏–≥–∞–Ω–∏—è</div>
            <div class="example-item" onclick="setErrorCode('P0171')">P0171 - –ë–µ–¥–Ω–∞—è —Å–º–µ—Å—å</div>
            <div class="example-item" onclick="setErrorCode('P0420')">P0420 - –ö–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä</div>
            <div class="example-item" onclick="setErrorCode('C1234')">C1234 - –ê–ë–°</div>

            <button class="btn btn-primary" onclick="nextStep()">
                –î–∞–ª–µ–µ ‚Üí
            </button>
        </div>

        <!-- –®–∞–≥ 2: –ú–∞—Ä–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è -->
        <div class="form-step" id="step2-content">
            <div class="input-group">
                <label for="carBrand">–ú–∞—Ä–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è:</label>
                <div class="selected-brand" id="selectedBrand" style="display: none;">
                    <div class="selected-item">
                        <span id="selectedBrandName"></span>
                        <button class="btn-change" onclick="changeBrand()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                    </div>
                </div>
                <div class="brand-selection" id="brandSelection">
                    <h4>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∞—Ä–∫–∏:</h4>
                    <div class="brand-buttons" id="popularBrandButtons">
                        <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                    <div class="search-section">
                        <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –º–∞—Ä–∫–∏..." id="brandSearch">
                        <div class="search-results" id="brandSearchResults"></div>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="nextStep()" id="nextStepBtn" disabled>
                –î–∞–ª–µ–µ ‚Üí
            </button>
            <button class="btn btn-secondary" onclick="skipMark()" style="margin-left: 10px;">
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –º–∞—Ä–∫–∏
            </button>
            <button class="btn btn-back" onclick="prevStep()">
                ‚Üê –ù–∞–∑–∞–¥
            </button>
        </div>

        <!-- –®–∞–≥ 3: –ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è -->
        <div class="form-step" id="step3-content">
            <div class="input-group">
                <label for="carModel">–ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è:</label>
                <div class="selected-model" id="selectedModel" style="display: none;">
                    <div class="selected-item">
                        <span id="selectedModelName"></span>
                        <button class="btn-change" onclick="changeModel()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                    </div>
                </div>
                <div class="model-selection" id="modelSelection">
                    <h4>–ú–æ–¥–µ–ª–∏:</h4>
                    <div class="model-buttons" id="modelButtons">
                        <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                    <div class="search-section">
                        <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –º–æ–¥–µ–ª–∏..." id="modelSearch">
                        <div class="search-results" id="modelSearchResults"></div>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="nextStep()" id="nextStepBtn3" disabled>
                –î–∞–ª–µ–µ ‚Üí
            </button>
            <button class="btn btn-secondary" onclick="skipModel()" style="margin-left: 10px;">
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –º–æ–¥–µ–ª–∏
            </button>
            <button class="btn btn-back" onclick="prevStep()">
                ‚Üê –ù–∞–∑–∞–¥
            </button>
        </div>

        <!-- –®–∞–≥ 4: –ü–æ–∫–æ–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è -->
        <div class="form-step" id="step4-content">
            <div class="input-group">
                <label for="carGeneration">–ü–æ–∫–æ–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è:</label>
                <div class="selected-generation" id="selectedGeneration" style="display: none;">
                    <div class="selected-item">
                        <span id="selectedGenerationName"></span>
                        <button class="btn-change" onclick="changeGeneration()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                    </div>
                </div>
                <div class="generation-selection" id="generationSelection">
                    <h4>–ü–æ–∫–æ–ª–µ–Ω–∏—è:</h4>
                    <div class="generation-buttons" id="generationButtons">
                        <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                    <div class="search-section">
                        <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ–∫–æ–ª–µ–Ω–∏—è..." id="generationSearch">
                        <div class="search-results" id="generationSearchResults"></div>
                    </div>
                </div>
            </div>

            <div class="car-info" id="carInfo" style="display: none;">
                <h4>üìã –°–æ–±—Ä–∞–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h4>
                <p><strong>–ö–æ–¥ –æ—à–∏–±–∫–∏:</strong> <span id="infoCode"></span></p>
                <p><strong>–ê–≤—Ç–æ–º–æ–±–∏–ª—å:</strong> <span id="infoCar"></span></p>
            </div>

            <button class="btn btn-primary" onclick="sendErrorCode()" id="sendBtn" disabled>
                üîç –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É
            </button>
            <button class="btn btn-secondary" onclick="skipGeneration()" style="margin-left: 10px;">
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –ø–æ–∫–æ–ª–µ–Ω–∏—è
            </button>
            <button class="btn btn-back" onclick="prevStep()">
                ‚Üê –ù–∞–∑–∞–¥
            </button>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let currentStep = 1;
        let formData = {
            errorCode: '',
            markId: null,
            modelId: null,
            generationId: null,
            carInfo: null
        };

        // –î–∞–Ω–Ω—ã–µ –∏–∑ JSON —Ñ–∞–π–ª–æ–≤
        let marksData = [];
        let modelsData = [];
        let generationsData = [];

        // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
        const errorInput = document.getElementById('errorCode');
        const brandInput = document.getElementById('carBrand');
        const modelInput = document.getElementById('carModel');
        const generationInput = document.getElementById('carGeneration');
        const carInfo = document.getElementById('carInfo');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        tg.ready();
        tg.expand();
        checkConnection();
        loadJsonData(); // –ó–∞–≥—Ä—É–∂–∞–µ–º JSON –¥–∞–Ω–Ω—ã–µ

        function checkConnection() {
            const status = document.getElementById('status');
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                status.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Telegram';
                status.className = 'status connected';
            } else {
                status.textContent = '‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Telegram (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)';
                status.className = 'status disconnected';
            }
        }

        function updateStepIndicator() {
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                if (i < currentStep) {
                    step.className = 'step completed';
                } else if (i === currentStep) {
                    step.className = 'step active';
                } else {
                    step.className = 'step';
                }
            }
        }

        function nextStep() {
            if (currentStep === 1) {
                if (!formData.errorCode.trim()) {
                    showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –æ—à–∏–±–∫–∏');
                    return;
                }
                formData.errorCode = formData.errorCode.trim().toUpperCase();
            } else if (currentStep === 2) {
                if (!formData.markId) {
                    showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä–∫—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è');
                    return;
                }
            } else if (currentStep === 3) {
                if (!formData.modelId) {
                    showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è');
                    return;
                }
            }

            if (currentStep < 4) {
                currentStep++;
                updateStepIndicator();
                
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —à–∞–≥–∏
                document.querySelectorAll('.form-step').forEach(step => {
                    step.classList.remove('active');
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —à–∞–≥
                document.getElementById(`step${currentStep}-content`).classList.add('active');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ —à–∞–≥–∞
                if (currentStep === 2) {
                    loadMarks();
                } else if (currentStep === 3) {
                    loadModels();
                } else if (currentStep === 4) {
                    loadGenerations();
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepIndicator();
                
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —à–∞–≥–∏
                document.querySelectorAll('.form-step').forEach(step => {
                    step.classList.remove('active');
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —à–∞–≥
                document.getElementById(`step${currentStep}-content`).classList.add('active');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ JSON –¥–∞–Ω–Ω—ã—Ö
        async function loadJsonData() {
            try {
                const [marksResponse, modelsResponse, generationsResponse] = await Promise.all([
                    fetch('marks.json'),
                    fetch('models.json'),
                    fetch('generations.json')
                ]);
                
                marksData = await marksResponse.json();
                modelsData = await modelsResponse.json();
                generationsData = await generationsResponse.json();
                
                console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${marksData.length} –º–∞—Ä–æ–∫, ${modelsData.length} –º–æ–¥–µ–ª–µ–π, ${generationsData.length} –ø–æ–∫–æ–ª–µ–Ω–∏–π`);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON –¥–∞–Ω–Ω—ã—Ö:', error);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–∞—Ä–æ–∫ (–ø–µ—Ä–≤—ã–µ 30)
        function getPopularMarks() {
            return marksData.slice(0, 30);
        }

        // –ü–æ–∏—Å–∫ –º–∞—Ä–æ–∫
        function searchMarks(query) {
            const lowerQuery = query.toLowerCase();
            return marksData.filter(mark => 
                mark.name.toLowerCase().includes(lowerQuery) || 
                (mark.cyrillic_name && mark.cyrillic_name.toLowerCase().includes(lowerQuery))
            ).slice(0, 20); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –ø–æ –º–∞—Ä–∫–µ
        function getModelsByMark(markId) {
            return modelsData.filter(model => model.mark_id === markId);
        }

        // –ü–æ–∏—Å–∫ –º–æ–¥–µ–ª–µ–π
        function searchModels(markId, query) {
            const lowerQuery = query.toLowerCase();
            const models = getModelsByMark(markId);
            return models.filter(model => 
                model.name.toLowerCase().includes(lowerQuery) || 
                (model.cyrillic_name && model.cyrillic_name.toLowerCase().includes(lowerQuery))
            ).slice(0, 20);
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∫–æ–ª–µ–Ω–∏–π –ø–æ –º–æ–¥–µ–ª–∏
        function getGenerationsByModel(modelId) {
            return generationsData.filter(generation => generation.model_id === modelId);
        }

        // –ü–æ–∏—Å–∫ –ø–æ–∫–æ–ª–µ–Ω–∏–π
        function searchGenerations(modelId, query) {
            const lowerQuery = query.toLowerCase();
            const generations = getGenerationsByModel(modelId);
            return generations.filter(generation => 
                generation.year_start.toString().includes(lowerQuery) || 
                generation.year_stop.toString().includes(lowerQuery)
            ).slice(0, 20);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadMarks() {
            const popularMarks = getPopularMarks();
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–∞—Ä–æ–∫
            const popularBrandButtons = document.getElementById('popularBrandButtons');
            popularBrandButtons.innerHTML = '';
            popularMarks.forEach(mark => {
                const button = document.createElement('button');
                button.className = 'brand-button';
                button.textContent = mark.name; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è
                button.onclick = () => selectMark(mark);
                popularBrandButtons.appendChild(button);
            });
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–∏—Å–∫
            setupBrandSearch();
        }

        async function loadModels() {
            if (!formData.markId) return;
            
            const models = getModelsByMark(formData.markId);
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–Ω–æ–ø–∫–∏ –º–æ–¥–µ–ª–µ–π
            const modelButtons = document.getElementById('modelButtons');
            modelButtons.innerHTML = '';
            models.slice(0, 30).forEach(model => { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 30
                const button = document.createElement('button');
                button.className = 'model-button';
                button.textContent = model.name; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è
                button.onclick = () => selectModel(model);
                modelButtons.appendChild(button);
            });
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–∏—Å–∫
            setupModelSearch();
        }

        async function loadGenerations() {
            if (!formData.modelId) return;
            
            const generations = getGenerationsByModel(formData.modelId);
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ–∫–æ–ª–µ–Ω–∏–π
            const generationButtons = document.getElementById('generationButtons');
            generationButtons.innerHTML = '';
            generations.slice(0, 30).forEach(generation => { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 30
                const button = document.createElement('button');
                button.className = 'generation-button';
                const yearText = generation.year_start === generation.year_stop ? 
                    generation.year_start : 
                    `${generation.year_start}-${generation.year_stop}`;
                button.textContent = yearText;
                button.onclick = () => selectGeneration(generation);
                generationButtons.appendChild(button);
            });
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–∏—Å–∫
            setupGenerationSearch();
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞ –º–∞—Ä–æ–∫
        function setupBrandSearch() {
            const brandSearch = document.getElementById('brandSearch');
            
            brandSearch.oninput = () => {
                const query = brandSearch.value.trim();
                if (query.length < 2) {
                    showBrandResults([]);
                    return;
                }
                
                const marks = searchMarks(query);
                showBrandResults(marks);
            };
        }

        function showBrandResults(marks) {
            const searchResults = document.getElementById('brandSearchResults');
            searchResults.innerHTML = '';
            
            marks.forEach(mark => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.textContent = mark.name; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è
                item.onclick = () => selectMark(mark);
                searchResults.appendChild(item);
            });
        }

        function showModelResults(models) {
            const searchResults = document.getElementById('modelSearchResults');
            searchResults.innerHTML = '';
            
            models.forEach(model => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.textContent = model.name; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è
                item.onclick = () => selectModel(model);
                searchResults.appendChild(item);
            });
        }

        function showGenerationResults(generations) {
            const searchResults = document.getElementById('generationSearchResults');
            searchResults.innerHTML = '';
            
            generations.forEach(generation => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                const yearText = generation.year_start === generation.year_stop ? 
                    generation.year_start : 
                    `${generation.year_start}-${generation.year_stop}`;
                item.textContent = yearText;
                item.onclick = () => selectGeneration(generation);
                searchResults.appendChild(item);
            });
        }

        function selectMark(mark) {
            formData.markId = mark.id;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–∞—Ä–∫—É
            const selectedBrand = document.getElementById('selectedBrand');
            const selectedBrandName = document.getElementById('selectedBrandName');
            const brandSelection = document.getElementById('brandSelection');
            const nextStepBtn = document.getElementById('nextStepBtn');
            
            selectedBrandName.textContent = mark.name; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è
            selectedBrand.style.display = 'block';
            brandSelection.style.display = 'none';
            nextStepBtn.disabled = false;
            
            // –û—á–∏—â–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ª—è
            formData.modelId = null;
            formData.generationId = null;
            formData.carInfo = null;
        }

        function selectModel(model) {
            formData.modelId = model.id;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å
            const selectedModel = document.getElementById('selectedModel');
            const selectedModelName = document.getElementById('selectedModelName');
            const modelSelection = document.getElementById('modelSelection');
            const nextStepBtn = document.getElementById('nextStepBtn3');
            
            selectedModelName.textContent = model.name; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è
            selectedModel.style.display = 'block';
            modelSelection.style.display = 'none';
            nextStepBtn.disabled = false;
            
            // –û—á–∏—â–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ª—è
            formData.generationId = null;
            formData.carInfo = null;
        }

        function selectGeneration(generation) {
            formData.generationId = generation.id;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ
            const selectedGeneration = document.getElementById('selectedGeneration');
            const selectedGenerationName = document.getElementById('selectedGenerationName');
            const generationSelection = document.getElementById('generationSelection');
            const sendBtn = document.getElementById('sendBtn');
            
            const yearText = generation.year_start === generation.year_stop ? 
                generation.year_start : 
                `${generation.year_start}-${generation.year_stop}`;
            selectedGenerationName.textContent = yearText;
            selectedGeneration.style.display = 'block';
            generationSelection.style.display = 'none';
            sendBtn.disabled = false;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ
            updateCarInfo();
        }

        // –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–ø—É—Å–∫–∞ —à–∞–≥–æ–≤
        function skipMark() {
            formData.markId = null;
            nextStep();
        }

        function skipModel() {
            formData.modelId = null;
            nextStep();
        }

        function skipGeneration() {
            formData.generationId = null;
            sendErrorCode();
        }

        // –§—É–Ω–∫—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞
        function changeBrand() {
            const selectedBrand = document.getElementById('selectedBrand');
            const brandSelection = document.getElementById('brandSelection');
            const nextStepBtn = document.getElementById('nextStepBtn');
            
            selectedBrand.style.display = 'none';
            brandSelection.style.display = 'block';
            nextStepBtn.disabled = true;
            formData.markId = null;
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π
        function setupModelSearch() {
            const modelSearch = document.getElementById('modelSearch');
            
            modelSearch.oninput = () => {
                const query = modelSearch.value.trim();
                if (query.length < 2) {
                    showModelResults([]);
                    return;
                }
                
                const models = searchModels(formData.markId, query);
                showModelResults(models);
            };
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–∫–æ–ª–µ–Ω–∏–π
        function setupGenerationSearch() {
            const generationSearch = document.getElementById('generationSearch');
            
            generationSearch.oninput = () => {
                const query = generationSearch.value.trim();
                if (query.length < 1) {
                    showGenerationResults([]);
                    return;
                }
                
                const generations = searchGenerations(formData.modelId, query);
                showGenerationResults(generations);
            };
        }

        function changeModel() {
            const selectedModel = document.getElementById('selectedModel');
            const modelSelection = document.getElementById('modelSelection');
            const nextStepBtn = document.getElementById('nextStepBtn3');
            
            selectedModel.style.display = 'none';
            modelSelection.style.display = 'block';
            nextStepBtn.disabled = true;
            formData.modelId = null;
        }

        function changeGeneration() {
            const selectedGeneration = document.getElementById('selectedGeneration');
            const generationSelection = document.getElementById('generationSelection');
            const sendBtn = document.getElementById('sendBtn');
            
            selectedGeneration.style.display = 'none';
            generationSelection.style.display = 'block';
            sendBtn.disabled = true;
            formData.generationId = null;
        }

        function changeBrand() {
            const selectedBrand = document.getElementById('selectedBrand');
            const brandSelection = document.getElementById('brandSelection');
            const nextStepBtn = document.getElementById('nextStepBtn');
            
            selectedBrand.style.display = 'none';
            brandSelection.style.display = 'block';
            nextStepBtn.disabled = true;
            
            formData.markId = null;
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π
        function setupModelSearch(models) {
            const modelSearch = document.getElementById('modelSearch');
            const modelDropdown = document.getElementById('modelDropdown');
            
            modelSearch.oninput = () => {
                const query = modelSearch.value.toLowerCase();
                const filtered = models.filter(model => 
                    model.name.toLowerCase().includes(query) || 
                    (model.cyrillic_name && model.cyrillic_name.toLowerCase().includes(query))
                );
                showModelResults(filtered);
            };
            
            modelInput.onclick = () => {
                modelDropdown.classList.add('show');
                modelSearch.focus();
            };
        }

        function showModelResults(models) {
            const modelDropdown = document.getElementById('modelDropdown');
            const items = modelDropdown.querySelectorAll('.dropdown-item');
            items.forEach(item => item.remove());
            
            models.forEach(model => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = model.cyrillic_name || model.name;
                item.onclick = () => selectModel(model);
                modelDropdown.appendChild(item);
            });
        }

        function selectModel(model) {
            formData.modelId = model.id;
            modelInput.value = model.cyrillic_name || model.name;
            document.getElementById('modelDropdown').classList.remove('show');
            // –û—á–∏—â–∞–µ–º —Å–ª–µ–¥—É—é—â–µ–µ –ø–æ–ª–µ
            generationInput.value = '';
            formData.generationId = null;
            formData.carInfo = null;
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–∫–æ–ª–µ–Ω–∏–π
        function setupGenerationSearch(generations) {
            const generationSearch = document.getElementById('generationSearch');
            const generationDropdown = document.getElementById('generationDropdown');
            
            generationSearch.oninput = () => {
                const query = generationSearch.value.toLowerCase();
                const filtered = generations.filter(gen => 
                    gen.name.toLowerCase().includes(query)
                );
                showGenerationResults(filtered);
            };
            
            generationInput.onclick = () => {
                generationDropdown.classList.add('show');
                generationSearch.focus();
            };
        }

        function showGenerationResults(generations) {
            const generationDropdown = document.getElementById('generationDropdown');
            const items = generationDropdown.querySelectorAll('.dropdown-item');
            items.forEach(item => item.remove());
            
            generations.forEach(generation => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                const yearText = generation.year_stop ? `${generation.year_start}-${generation.year_stop}` : `${generation.year_start}-`;
                item.textContent = `${generation.name} (${yearText})`;
                item.onclick = () => selectGeneration(generation);
                generationDropdown.appendChild(item);
            });
        }

        function selectGeneration(generation) {
            formData.generationId = generation.id;
            formData.carInfo = {
                mark: brandInput.value,
                model: modelInput.value,
                generation: generation.name,
                yearFrom: generation.year_start,
                yearTo: generation.year_stop
            };
            const yearText = generation.year_stop ? `${generation.year_start}-${generation.year_stop}` : `${generation.year_start}-`;
            generationInput.value = `${generation.name} (${yearText})`;
            document.getElementById('generationDropdown').classList.remove('show');
            showCarInfo();
        }

        function showCarInfo() {
            if (formData.carInfo) {
                document.getElementById('infoCode').textContent = formData.errorCode;
                const yearText = formData.carInfo.yearTo ? `${formData.carInfo.yearFrom}-${formData.carInfo.yearTo}` : `${formData.carInfo.yearFrom}-`;
                document.getElementById('infoCar').textContent = 
                    `${formData.carInfo.mark} ${formData.carInfo.model} ${formData.carInfo.generation} (${yearText})`;
                carInfo.style.display = 'block';
            }
        }

        function setErrorCode(code) {
            errorInput.value = code;
            formData.errorCode = code;
        }

        function updateCarInfo() {
            if (formData.markId && formData.modelId && formData.generationId) {
                const mark = marksData.find(m => m.id === formData.markId);
                const model = modelsData.find(m => m.id === formData.modelId);
                const generation = generationsData.find(g => g.id === formData.generationId);
                
                if (mark && model && generation) {
                    formData.carInfo = {
                        mark: mark.name,
                        model: model.name,
                        generation: `${generation.year_start}-${generation.year_stop}`,
                        yearFrom: generation.year_start,
                        yearTo: generation.year_stop
                    };
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ
                    document.getElementById('infoCode').textContent = formData.errorCode;
                    document.getElementById('infoCar').textContent = `${mark.name} ${model.name} ${generation.year_start}-${generation.year_stop}`;
                    document.getElementById('carInfo').style.display = 'block';
                }
            }
        }

        async function sendErrorCode() {
            const errorCode = formData.errorCode;
            const carInfo = formData.carInfo;
            
            if (!errorCode) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –æ—à–∏–±–∫–∏');
                return;
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –±–æ—Ç–∞
            let message = `üîç **–ö–æ–¥ –æ—à–∏–±–∫–∏:** ${errorCode}\n\n`;
            
            if (carInfo) {
                message += `üöó **–ê–≤—Ç–æ–º–æ–±–∏–ª—å:**\n`;
                message += `‚Ä¢ –ú–∞—Ä–∫–∞: ${carInfo.mark}\n`;
                message += `‚Ä¢ –ú–æ–¥–µ–ª—å: ${carInfo.model}\n`;
                message += `‚Ä¢ –ü–æ–∫–æ–ª–µ–Ω–∏–µ: ${carInfo.generation}\n`;
                message += `‚Ä¢ –ì–æ–¥—ã: ${carInfo.yearFrom}-${carInfo.yearTo}\n\n`;
            }
            
            message += `üìù **–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram...**`;
            
            // –í —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
                showSuccess(message);
                console.log('–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º - –¥–∞–Ω–Ω—ã–µ:', { errorCode, carInfo });
                return;
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram
            tg.sendData(JSON.stringify({
                errorCode: errorCode,
                carInfo: carInfo
            }));
            
            showSuccess('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Telegram!');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function showResult(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.innerHTML = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/`(.*?)`/g, '<code>$1</code>');
            successDiv.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function resetForm() {
            errorInput.value = '';
            brandInput.value = '';
            modelInput.value = '';
            generationInput.value = '';
            formData = {
                errorCode: '',
                markId: null,
                modelId: null,
                generationId: null,
                carInfo: null
            };
            currentStep = 1;
            updateStepIndicator();
            document.querySelectorAll('.form-step').forEach(step => step.classList.remove('active'));
            document.getElementById('step1-content').classList.add('active');
            carInfo.style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        errorInput.addEventListener('input', function() {
            formData.errorCode = this.value;
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-list').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });
    </script>
</body>
</html> 